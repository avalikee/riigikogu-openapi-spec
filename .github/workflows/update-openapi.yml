name: Update Riigikogu OpenAPI

on:
    schedule:
        - cron: "0 20 * * *" # Daily 20:00 UTC
    workflow_dispatch:
    push:
        branches:
            - main

permissions:
    contents: write

concurrency:
    group: update-openapi
    cancel-in-progress: true

jobs:
    update:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up mise
              uses: jdx/mise-action@v2

            - name: Install tools from mise.toml
              run: mise install

            - name: Install JS dependencies
              run: bun install --frozen-lockfile

            - name: Run spec-fetcher
              id: fetch
              run: |
                  set -e
                  result=$(bun tools/spec-fetcher.ts --url "https://api.riigikogu.ee/v3/api-docs" --output-json "riigikogu-openapi.json" --output-sha256 "riigikogu-openapi.json.sha256" | tail -n 1)
                  echo "$result"
                  echo "status=$result" >> "$GITHUB_OUTPUT"

            - name: Render template files
              run: bun tools/render-templates.ts

            - name: Format JS entries
              run: prettier --write dest

            - name: Read spec version
              id: spec_version
              run: bun tools/read-spec-version.ts --json-file riigikogu-openapi.json >> "$GITHUB_OUTPUT"

            - name: Check for file changes
              id: check_changes
              run: bun tools/check-file-changes.ts --files "riigikogu-openapi.json,riigikogu-openapi.json.sha256" >> "$GITHUB_OUTPUT"

            - name: Check if spec version changed
              id: check_spec_version
              run: bun tools/check-spec-version.ts --new-version "${{ steps.spec_version.outputs.version }}" >> "$GITHUB_OUTPUT"

            - name: Sync package.json version
              id: sync_version
              run: |
                  if [ "${{ github.event_name }}" = "push" ]; then
                      # On push to main: always bump patch (internal release)
                      bun tools/sync-version.ts --set-version "${{ steps.spec_version.outputs.version }}" --increment-revision >> "$GITHUB_OUTPUT"
                  else
                      if [ "${{ steps.check_changes.outputs.changed }}" = "true" ]; then
                          if [ "${{ steps.check_spec_version.outputs.spec_changed }}" = "true" ]; then
                              bun tools/sync-version.ts --set-version "${{ steps.spec_version.outputs.version }}" >> "$GITHUB_OUTPUT"
                          else
                              bun tools/sync-version.ts --set-version "${{ steps.spec_version.outputs.version }}" --increment-revision >> "$GITHUB_OUTPUT"
                          fi
                      else
                          echo "updated=false" >> "$GITHUB_OUTPUT"
                      fi
                  fi

            - name: Commit generated files and version bump
              if: steps.sync_version.outputs.updated == 'true'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  git add riigikogu-openapi.json riigikogu-openapi.json.sha256 package.json
                  git commit -m "release: v${{ steps.sync_version.outputs.version }}" --no-verify
                  git push

            - name: Publish to npm with Bun
              if: steps.sync_version.outputs.updated == 'true'
              run: bun publish --access public --tolerate-republish
              env:
                  NPM_CONFIG_TOKEN: ${{ secrets.NPM_TOKEN }}
