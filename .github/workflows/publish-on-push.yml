name: Publish on Push (Patch Release)

on:
    push:
        branches:
            - main

permissions:
    contents: write

concurrency:
    group: publish-on-push
    cancel-in-progress: true

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up mise
              uses: jdx/mise-action@v2

            - name: Install tools from mise.toml
              run: mise install

            - name: Install JS dependencies
              run: bun install --frozen-lockfile

            - name: Run spec-fetcher
              run: bun tools/spec-fetcher.ts --url "https://api.riigikogu.ee/v3/api-docs" --output-json "riigikogu-openapi.json" --output-sha256 "riigikogu-openapi.json.sha256"

            - name: Render template files
              run: bun tools/render-templates.ts

            - name: Format JS entries
              run: prettier --write dest

            - name: Read spec version
              id: spec_version
              run: bun tools/read-spec-version.ts --json-file riigikogu-openapi.json >> "$GITHUB_OUTPUT"

            - name: Check if spec version changed
              id: check_spec_version
              run: bun tools/check-spec-version.ts --new-version "${{ steps.spec_version.outputs.version }}" >> "$GITHUB_OUTPUT"

            - name: Sync package.json version (patch)
              id: sync_version
              run: bun tools/sync-version.ts --set-version "${{ steps.spec_version.outputs.version }}" --increment-revision >> "$GITHUB_OUTPUT"

            - name: Commit generated files and version bump
              if: steps.sync_version.outputs.updated == 'true'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  if [ "${{ steps.check_spec_version.outputs.spec_changed }}" = "true" ]; then
                      git add riigikogu-openapi.json riigikogu-openapi.json.sha256
                  fi
                  git add package.json
                  if git diff --cached --quiet; then
                      echo "No changes to commit."
                  else
                      git commit -m "release: v${{ steps.sync_version.outputs.version }}" --no-verify
                  fi
                  git push

            - name: Publish to npm with Bun
              if: steps.sync_version.outputs.updated == 'true'
              run: bun publish --access public --tolerate-republish
              env:
                  NPM_CONFIG_TOKEN: ${{ secrets.NPM_TOKEN }}
